name: Deploy Next.js to EC2 (Ziriguidum)
on:
  push:
    branches:
      - main  # deploy when pushing to main branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Build Next.js project
      - name: Build project
        env:
            NEXT_PUBLIC_PRICE_IN_PERSON_SOLIDARITY: ${{ secrets.NEXT_PUBLIC_PRICE_IN_PERSON_SOLIDARITY }}
            NEXT_PUBLIC_PRICE_IN_PERSON_EARLY_BIRD: ${{ secrets.NEXT_PUBLIC_PRICE_IN_PERSON_EARLY_BIRD }}
            NEXT_PUBLIC_PRICE_IN_PERSON_LATE_BIRD: ${{ secrets.NEXT_PUBLIC_PRICE_IN_PERSON_LATE_BIRD }}
            NEXT_PUBLIC_PRICE_IN_PERSON_FULL: ${{ secrets.NEXT_PUBLIC_PRICE_IN_PERSON_FULL }}
            NEXT_PUBLIC_PRICE_ONLINE_SOLIDARITY: ${{ secrets.NEXT_PUBLIC_PRICE_ONLINE_SOLIDARITY }}
            NEXT_PUBLIC_PRICE_ONLINE_EARLY_BIRD: ${{ secrets.NEXT_PUBLIC_PRICE_ONLINE_EARLY_BIRD }}
            NEXT_PUBLIC_PRICE_ONLINE_LATE_BIRD: ${{ secrets.NEXT_PUBLIC_PRICE_ONLINE_LATE_BIRD }}
            NEXT_PUBLIC_PRICE_ONLINE_FULL: ${{ secrets.NEXT_PUBLIC_PRICE_ONLINE_FULL }}
            STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
            NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
        run: npm run build

      # 5Ô∏è‚É£ Archive production files
      - name: Archive build
        run: |
            if [ -d public ]; then
                tar -czf build.tar.gz .next package.json package-lock.json public
            else
                tar -czf build.tar.gz .next package.json package-lock.json
            fi

      # 6Ô∏è‚É£ Copy build to EC2 temporary folder
      - name: Copy to EC2 temp folder
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "build.tar.gz"
          target: "~/ziriguidum_tmp/"

      # 7Ô∏è‚É£ SSH to EC2 and deploy (with backup & safe swap)
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            echo "üìÅ Preparing temporary folder..."
            mkdir -p ~/ziriguidum_tmp
            cd ~/ziriguidum_tmp

            echo "üì¶ Extracting build..."
            tar -xzf build.tar.gz
            rm build.tar.gz

            echo "üì¶ Installing production dependencies..."
            npm ci --omit=dev

            echo "üîç Validating build..."
            if [ ! -d ".next" ]; then
              echo "‚ùå ERROR: .next folder missing after extraction"
              exit 1
            fi

            echo "üõë Stopping PM2 app..."
            pm2 stop ziriguidum-app || true

            echo "üìÇ Creating backup of current version..."
            if [ -d ~/ziriguidum_app ]; then
              rm -rf ~/ziriguidum_app_backup
              mv ~/ziriguidum_app ~/ziriguidum_app_backup
            fi

            echo "üöö Promoting new build..."
            mv ~/ziriguidum_tmp ~/ziriguidum_app

            echo "üöÄ Starting new PM2 app..."
            if pm2 start npm --name "ziriguidum-app" -- run start -- -p 3002; then
              echo "‚úÖ New version is running successfully!"
              pm2 save

              echo "üßπ Cleaning up old stopped PM2 processes..."
              pm2 ls --no-color | awk '/stopped/ {print $2}' | xargs -r pm2 delete

              echo "üßπ Deleting old backup..."
              rm -rf ~/ziriguidum_app_backup

            else
              echo "‚ùå New version FAILED to start. Rolling back..."
              rm -rf ~/ziriguidum_app
              mv ~/ziriguidum_app_backup ~/ziriguidum_app
              pm2 start npm --name "ziriguidum-app" -- run start -- -p 3002
              pm2 save
              echo "‚ôªÔ∏è Rollback complete."
              exit 1
            fi

            echo "üßπ Cleaning tmp folder..."
            rm -rf ~/ziriguidum_tmp
            echo "‚úÖ Deployment completed successfully!"
